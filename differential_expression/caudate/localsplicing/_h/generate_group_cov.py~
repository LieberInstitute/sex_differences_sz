#!/usr/bin/python

import pandas as pd
from rpy2.robjects import r, pandas2ri

def main():
    pheno_file = '../../../inputs/phenotypes/_m/caudate_phenotypes.csv'
    pheno = pd.read_csv(pheno_file, index_col=0)
    pheno = pheno[(pheno['Dx'].isin(['Control', 'Schizo'])) & (pheno['Age'] > 13)]

    counts = pd.read_csv('../../../inputs/leafcutter/_m/caudate_perind_numers.counts.gz',
                         sep=' ', nrows=500).T
    pheno = pd.merge(pheno, counts, left_index=True, right_index=True)\
              .drop(counts.columns, axis=1)

    pandas2ri.activate()
    r('''
    voomDat = '../../differential_expression/_m/genes/voomSVA.RData'
    load(voomDat)
    dft = data.frame(v$design)
    dft['RNum'] = rownames(v$design)
    ''')
    qsva_plus = r['dft'].set_index('RNum')
    new_pheno = pd.merge(pheno[['Dx', 'Sex', 'Age']],
		         qsva_plus.iloc[:, 4:],
		         left_index=True, right_index=True)
    new_pheno.to_csv('groups_cov_file.txt', sep=' ', header=False)


if __name__ == '__main__':
    main()
